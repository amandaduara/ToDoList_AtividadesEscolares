<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atividades</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">

        <!-- Exibindo as atividade -->
        <h2>Atividades</h2>

        <table id="atividadeTable">
            <thead>
                <tr> <!-- Cabeçalho da tabela -->
                    <th>Matéria</th>
                    <th>Descrição</th>
                    <th>Data de vencimento</th>
                </tr>
            </thead>
            <tbody>
                <!-- As atividades serão inseridas aqui via JS -->
            </tbody>
        </table>

        <!-- Criando uma nova atividade -->
        <h2>Adicionar Tarefa</h2>
        <form id="addAtividadeForm">

            <label for="materia">Matéria:</label>
            <input type="text" id="materia" required>

            <label for="descricao">Descrição da atividade:</label>
            <input type="text" id="descricao" required>

            <label for="data">Data de vencimento:</label>
            <input type="date" id="data" required>

            <button type="submit">Adicionar</button>
        </form>

        <!-- Atualizando uma nova atividade -->
        <h2>Atualizar Atividade</h2>
        <form id="updateAtividadeForm">

            <input type="hidden" id="updateId"> <!-- Campo oculto que guarda o Id da atividade a ser atualizada -->

            <label for="updateMateria">Matéria:</label>
            <input type="text" id="updateMateria" required>

            <label for="updateDescricao">Descrição:</label>
            <input type="text" id="updateDescricao" required>

            <label for="updateData">Data do vencimento:</label>
            <input type="date" id="updateData" required>

            <button type="submit">Atualizar</button>
        </form>
    </div>
</body>
</html>

<script>
    // --- Função para buscar e exibir todas as atividades da API ---
    function getAtividades(){
        fetch('https://localhost:7125/api/atividades/atividades')
            .then(response => response.json())
            .then(data => {
                const atividadeTable = document.getElementById('atividadeTable');
                const tbody = atividadeTable.querySelector('tbody');
                tbody.innerHTML = ''; // Limpa a tabela antes de preencher novamente

                data.forEach(atividade => { // Para cada atividade recebida da API...
                    const row = document.createElement('tr'); // Cria uma nova linha da tabela

                    // Cria e preenche a célula da matéria
                    const materiaCell = document.createElement('td');
                    materiaCell.textContent = atividade.materia;
                    row.appendChild(materiaCell);

                    const descricaoCell = document.createElement('td');
                    descricaoCell.textContent = atividade.descricao;
                    row.appendChild(descricaoCell);

                    const dataCell = document.createElement('td');
                    dataCell.textContent = atividade.data_atividade;
                    row.appendChild(dataCell);

                    // Cria os botões de excluir e atualizar uma atividade
                    const actionsCell = document.createElement('td');
                    row.appendChild(actionsCell); // Adiciona os botões na linha
                    tbody.appendChild(row); // Adiciona a linha na tabela

                    // Botão de excluir ao lado de cada tarefa
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Excluir';
                    deleteButton.addEventListener('click', () => deleteAtividade(atividade.id_tarefa));
                    actionsCell.appendChild(deleteButton); 

                    // Botão de atualizar ao lado de cada tarefa
                    const updateButton = document.createElement('button');
                    updateButton.textContent = 'Atualizar';
                    updateButton.addEventListener('click', () => preencherUpdateForm(atividade));
                    actionsCell.appendChild(updateButton);

                    // Função que preenche o formulário de atualização com os dados da atividade clicada
                    function preencherUpdateForm(atividade) {
                        document.getElementById('updateId').value = atividade.id_tarefa;
                        document.getElementById('updateMateria').value = atividade.materia;
                        document.getElementById('updateDescricao').value = atividade.descricao;
                        document.getElementById('updateData').value = atividade.data_atividade;
                    }
                });
            });
    }

    // --- Função para adicionar uma nova atividade ---
    function addAtividade(event) {
        event.preventDefault(); // Impede que a página recarregue ao enviar o formulário

        // Valores capturados dos campos do formulário
        const materia = document.getElementById('materia').value;
        const descricao = document.getElementById('descricao').value;
        const data = document.getElementById('data').value;

        // Objeto sendo criado com os dados da nova atividade
        const atividade =
        {
            materia: materia,
            descricao: descricao,
            data_atividade: data
        };

        // Envia os dados para a API usando o método POST
        fetch('https://localhost:7125/api/atividades',
        {
            method: 'POST',
            headers:
            {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(atividade)
        })
        .then(response => {
            if (response.ok)
            {
                // Limpa o formulário após o envio
                document.getElementById('materia').value = '';
                document.getElementById('descricao').value = '';
                document.getElementById('data').value = '';
                getAtividades(); // Atualiza a tabela após adicionar uma atividade
            }
        });
    }

    // --- Função para atualizar de uma atividade ---
    function updateAtividade(event) {
        event.preventDefault(); // Impede o recarregamento da página

        // Captura os dados preenchidos no formulário de atualização
        const id_tarefa = parseInt(document.getElementById('updateId').value);
        const materia = document.getElementById('updateMateria').value;
        const descricao = document.getElementById('updateDescricao').value;
        const data = document.getElementById('updateData').value;

        const atividade =
        {
            // Monta o objeto com os dados atualizados
            id_tarefa: id_tarefa,
            materia: materia,
            descricao: descricao,
            data_atividade: data
        };

        // Envia os dados atualizados para a API usando PUT
        fetch(`https://localhost:7125/api/atividades/${id_tarefa}`,
            {
                method: 'PUT',
                headers:
                {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(atividade)
            })
        .then(response => {
            if (response.ok)
            {
                 // Limpa o formulário após a atualização
                 document.getElementById('updateId').value = '';
                 document.getElementById('updateMateria').value = '';
                 document.getElementById('updateDescricao').value = '';
                 document.getElementById('updateData').value = '';
                getAtividades(); // Atualiza a tabela após atualizar uma atividade
            }
        });
    }
    // --- Função para deletar uma atividade pelo ID ---
    function deleteAtividade(id_tarefa)
    {
        fetch(`https://localhost:7125/api/atividades/${id_tarefa}`,
        {
            method: 'DELETE'
        })

        .then(response => {
            if (response.ok)
            {
                getAtividades(); // Atualiza a tabela após excluir
            }
        });
    }

    // Liga os formulários às funções usando eventos
    document.getElementById('addAtividadeForm').addEventListener('submit', addAtividade);
    document.getElementById('updateAtividadeForm').addEventListener('submit', updateAtividade);

    // Mostra as atividades já cadastradas ao carregar a página
    getAtividades();
</script>